import { useState, useEffect } from 'react';
import Head from 'next/head';
import { Web3Provider } from '@ethersproject/providers';
import ValistLicenseClient from 'valist-license-sdk-ts';
import styles from '../styles/Home.module.css';

export default function Home() {
  const [provider, setProvider] = useState<Web3Provider | null>(null);
  const [chainId, setChainId] = useState<number | null>(null);
  const [account, setAccount] = useState('');
  const [projectIdInput, setProjectIdInput] = useState('');
  const [hasLicense, setHasLicense] = useState(true);
  const [logMessage, setLogMessage] = useState('');

  const connectWallet = async () => {
    try {
      if ((window as any)?.ethereum) {
        const accounts = await (window as any).ethereum.request({
          method: "eth_requestAccounts"
        });
        console.log("Using account: ", accounts[0]);
        const provider = new Web3Provider((window as any)?.ethereum);
        const { chainId } = await provider.getNetwork();
        if (chainId !== 80001) {
          console.log("Please connect to Polygon Mumbai Testnet");
          // switch to the polygon testnet
          await (window as any).ethereum
            .request({
              method: "wallet_switchEthereumChain",
              params: [{ chainId: "0x13881" }]
            });
        }
        console.log("chainId:", chainId);
        setProvider(provider);
        setChainId(chainId);
        setAccount(accounts[0]);
      } else {
        console.log("Please use Web3 enabled browser");
        setLogMessage("Please use Web3 enabled browser");
      }
    } catch (err: any) {
      console.log("Error connecting wallet", err);
      setLogMessage(`Error connecting wallet: ${err.message}`);
    }
  };
  const purchaseLicense = async () => {
    try {
      if (!projectIdInput) throw new Error('Please enter a project id');
      const valistLicenseClient = new ValistLicenseClient(provider, chainId);
      const tx = await valistLicenseClient.purchaseLicense(projectIdInput, account);
      console.log('tx', tx);
      await tx.wait();
      console.log('License purchased');
      setLogMessage('License purchased');
    } catch (err: any) {
      console.log("Error purchasing license", err);
      setLogMessage(`Error purchasing license: ${err.message}`);
    }
  };

  const purchaseLicenseWithToken = async () => {
    try {
      if (!projectIdInput) return setLogMessage("Please enter a projectId");
      const valistLicenseClient = new ValistLicenseClient(provider, chainId);
      const tx = await valistLicenseClient.purchaseLicenseWithToken(projectIdInput, account, '0xe6b8a5CF854791412c1f6EFC7CAf629f5Df1c747');
      console.log('tx', tx);
      await tx.wait();
      console.log('License purchased with USDC');
      setLogMessage('License purchased with USDC');
    } catch (err: any) {
      console.log("Error purchasing license with USDC", err);
      setLogMessage(`Error purchasing license with USDC: ${err.message}`);
    }
  };
  const checkLicense = async () => {
    try {
      const valistLicenseClient = new ValistLicenseClient(provider, chainId);
      if (!projectIdInput) return setLogMessage("Please enter a projectId");
      const signingMessage = "I am signing this message";
      const hasLicense = await valistLicenseClient.checkLicense(12, signingMessage);
      console.log('hasLicense', hasLicense);
      setHasLicense(hasLicense);
      setLogMessage(hasLicense ? 'You have a license for this project' : 'You do not have a license for this project');
    } catch (err: any) {
      console.log("Error checking license", err);
      setLogMessage(`Error checking license: ${err.message}`);
    }
  };

  useEffect(() => {
    if (provider) {
      console.log("window.ethereum", (window as any).ethereum);
      (window as any).ethereum.on("accountsChanged", () => window.location.reload());
      (window as any).ethereum.on("chainChanged", () => window.location.reload());
      (window as any).ethereum.on("connect", (info: any) =>
        console.log("connected to network", info)
      );
    }
    return () => {
      if (provider) {
        (window as any).ethereum.removeAllListeners();
      }
    };
  }, [provider]);

  return (
    <div className={styles.container}>
      <Head>
        <title>Valist License Gating App</title>
        <meta name="description" content="Generated by create next app" />
        <link rel="icon" href="/favicon.ico" />
      </Head>

      <main className={styles.main}>
        <h1 className={styles.title}>
          Welcome to <a href="https://nextjs.org">Valist License Gating</a>
        </h1>

        <p className={styles.description}>
          Get started by connecting your wallet
        </p>
        {account ? (
          <div>
            <p>Connected with <b>{account}</b></p>
            <input
              className={styles.input}
              type="text"
              placeholder="Enter Project ID"
              value={projectIdInput}
              onChange={(e) => setProjectIdInput(e.target.value)}
            />
            <button className={styles.button} onClick={checkLicense}>Check License</button>
            {!hasLicense && (
              <>
                {/* purchase license with token */}
                <button className={styles.button} onClick={purchaseLicense}>Purchase License</button>
                <button className={styles.button} onClick={purchaseLicenseWithToken}>Purchase License with USDC</button>
              </>
            )}
          </div>
        ) : (
          <button className={styles.button} onClick={connectWallet}>Connect Wallet</button>
        )}
        <b>{logMessage}</b>
      </main>

      <footer className={styles.footer}>
        <a
          href="https://github.com/Salmandabbakuti"
          target="_blank"
          rel="noopener noreferrer"
        >
          Â© 2022 Salman Dabbakuti. Built with Lit Protocol
        </a>
      </footer>
    </div>
  );
}
